---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: argocd
resources:
  - https://raw.githubusercontent.com/argoproj/argo-cd/v2.12.4/manifests/ha/install.yaml
  - base/namespace.yaml
  - base/ingress.yaml
  - https://raw.githubusercontent.com/argoproj-labs/argocd-image-updater/master/manifests/install.yaml
  - base/secrets.yaml
  - base/docker-registry-secret.yaml

patches:
  - path: overlays/argocd-cm.yaml
  - path: overlays/argocd-rbac-cm.yaml
  - path: overlays/argocd-cmd-params-cm.yaml
  - path: overlays/argocd-lovely-plugin.yaml
    target:
      kind: Deployment
      name: argocd-repo-server
  - path: overlays/argocd-image-updater-config.yaml

# https://github.com/argoproj/argo-cd/issues/16623#issuecomment-2176566772
patchesJson6902:
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: argocd-repo-server
    patch: |
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: dockerconfigjson
          secret:
            secretName: docker-registry-auth
            items:
              - key: .dockerconfigjson
                path: config.json
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: dockerconfigjson
          mountPath: /home/argocd/.docker/
          readOnly: true
      - op: replace
        path: /spec/template/spec/containers/0/securityContext/readOnlyRootFilesystem
        value: false

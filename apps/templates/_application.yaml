{{- define "application" }}
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: apps
  namespace: argocd
spec:
  generators:
    - list:
        elements:
        {{- range $application := .Values.applications }}
        {{- $enabled := default false $application.enabled }}
        {{- if $enabled }}
          - name: {{ $application.name }}
            namespace: {{ $application.namespace | default "default" }}
            {{- if hasKey $application "sources" }}
            sources:
            {{- range $source := $application.sources }}
              - repoURL: {{ $source.repoURL | default $.Values.spec.source.repoURL }}
                targetRevision: {{ $source.targetRevision | default $.Values.spec.source.targetRevision }}
                path: {{ $source.path }}
                {{- if hasKey $source "plugin" }}
                plugin:
                  name: {{ $source.plugin.name }}
                {{- end }}
            {{- end }}
            {{- else }}
            path: {{ $application.path }}
            {{- end }}
        {{- end }}
        {{- end }}
  template:
    metadata:
      name: '{{`{{name}}`}}'
      namespace: argocd
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: default
      {{- if hasKey . "sources" }}
      sources:
      {{`{{- range .sources }}`}}
      - repoURL: '{{`{{.repoURL}}`}}'
        targetRevision: '{{`{{.targetRevision}}`}}'
        path: '{{`{{.path}}`}}'
        {{`{{- if .plugin }}`}}
        plugin:
          name: '{{`{{.plugin.name}}`}}'
        {{`{{- end }}`}}
      {{`{{- end }}`}}
      {{- else }}
      source:
        repoURL: {{ .Values.spec.source.repoURL }}
        targetRevision: {{ .Values.spec.source.targetRevision }}
        path: '{{`{{path}}`}}'
        plugin:
          name: lovely
      {{- end }}
      destination:
        server: {{ .Values.spec.destination.server }}
        namespace: '{{`{{namespace}}`}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
          allowEmpty: true
        syncOptions:
          - CreateNamespace=true
{{- end }}

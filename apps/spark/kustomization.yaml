apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: spark
helmCharts:
  - name: spark
    namespace: spark
    releaseName: spark
    repo: oci://registry-1.docker.io/bitnamicharts/spark
    version: 9.2.1
    valuesInline:
      global:
        storageClass: "longhorn"

      master:
        resources:
          limits:
            cpu: 2000m
            memory: 4Gi
          requests:
            cpu: 1000m
            memory: 2Gi
        persistence:
          enabled: true
          size: 8Gi
        configOptions:
          - "-Dspark.ui.reverseProxy=true"
          - "-Dspark.ui.reverseProxyUrl=http://spark.lan"

      worker:
        replicaCount: 3
        resources:
          limits:
            cpu: 4000m
            memory: 8Gi
          requests:
            cpu: 2000m
            memory: 4Gi
        persistence:
          enabled: true
          size: 20Gi
        configOptions:
          - "-Dspark.ui.reverseProxy=true"
          - "-Dspark.ui.reverseProxyUrl=http://spark.lan"
        autoscaling:
          enabled: true
          minReplicas: 3
          maxReplicas: 6
          targetCPU: 70

      ingress:
        enabled: true
        hostname: spark.lan

      security:
        passwordless: true
        rpc:
          authenticationEnabled: false
          encryptionEnabled: false

      metrics:
        enabled: true
        masterAnnotations:
          prometheus.io/scrape: "true"
          prometheus.io/port: "8080"
        workerAnnotations:
          prometheus.io/scrape: "true"
          prometheus.io/port: "8080"
        podMonitor:
          enabled: true
          interval: 30s
          scrapeTimeout: 10s

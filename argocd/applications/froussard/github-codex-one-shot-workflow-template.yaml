apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: github-codex-one-shot
  namespace: argo-workflows
spec:
  serviceAccountName: argo-workflows-workflow
  entrypoint: run
  arguments:
    parameters:
      - name: rawEvent
        value: '{}'
      - name: eventBody
        value: '{}'
  templates:
    - name: run
      inputs:
        parameters:
          - name: rawEvent
          - name: eventBody
      container:
        image: registry.ide-newton.ts.net/lab/codex-universal:latest
        command: ["/usr/local/bin/codex-bootstrap.sh"]
        args:
          - "/bin/bash"
          - "-lc"
          - |
            set -euo pipefail

            EVENT_FILE=$(mktemp)
            cat <<'JSON' > "$EVENT_FILE"
            {{inputs.parameters.eventBody}}
            JSON

            STAGE=$(jq -r '.stage // ""' "$EVENT_FILE")
            if [[ "$STAGE" != "one-shot" ]]; then
              echo "Skipping unsupported stage: '$STAGE'"
              exit 0
            fi

            WORKTREE_DIR="${WORKTREE:-/workspace/lab}"

            echo "Executing one-shot Codex workflow" >&2
            "${WORKTREE_DIR}/apps/froussard/scripts/codex-one-shot.sh" "$EVENT_FILE"
      resources:
        requests:
          cpu: "4"
          memory: 8Gi
        limits:
          cpu: "6"
          memory: 12Gi

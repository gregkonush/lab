apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: workflow-completions
  namespace: argo-workflows
spec:
  dependencies:
    - name: workflow-completion
      eventSourceName: workflow-completions
      eventName: workflowCompletions
      filters:
        data:
          - path: body.status.finishedAt
            type: string
            value:
              - ".+"
          - path: body.status.phase
            type: string
            value:
              - Succeeded
              - Failed
              - Error
  eventBusName: default
  template:
    serviceAccountName: workflow-completions-sensor
  triggers:
    - template:
        name: publish-workflow-completion
        kafka:
          url: kafka-kafka-bootstrap.kafka:9092
          topic: argo.workflows.completions
          sasl:
            mechanism: SCRAM-SHA-512
            userSecret:
              name: kafka-codex-credentials
              key: username
            passwordSecret:
              name: kafka-codex-credentials
              key: password
          payload:
            - dest: metadata
              src:
                dependencyName: workflow-completion
                useRawData: true
                dataTemplate: |
                  {{- $wf := .Input.body -}}
                  {{- $meta := coalesce (index $wf "metadata") (dict) -}}
                  {{- $labels := coalesce (index $meta "labels") (dict) -}}
                  {{- $annotations := coalesce (index $meta "annotations") (dict) -}}
                  {{- toJson (dict
                        "name" (default "" (index $meta "name"))
                        "namespace" (default "" (index $meta "namespace"))
                        "uid" (default "" (index $meta "uid"))
                        "labels" $labels
                        "annotations" $annotations
                    ) }}
            - dest: status
              src:
                dependencyName: workflow-completion
                useRawData: true
                dataTemplate: |
                  {{- $status := coalesce (index .Input.body "status") (dict) -}}
                  {{- toJson (dict
                        "phase" (default "" (index $status "phase"))
                        "startedAt" (default "" (index $status "startedAt"))
                        "finishedAt" (default "" (index $status "finishedAt"))
                    ) }}
            - dest: arguments
              src:
                dependencyName: workflow-completion
                useRawData: true
                dataTemplate: |
                  {{- $spec := coalesce (index .Input.body "spec") (dict) -}}
                  {{- toJson (coalesce (index $spec "arguments") (dict)) }}
            - dest: stage
              src:
                dependencyName: workflow-completion
                dataTemplate: |
                  {{- $wf := .Input.body -}}
                  {{- $meta := coalesce (index $wf "metadata") (dict) -}}
                  {{- $labels := coalesce (index $meta "labels") (dict) -}}
                  {{- default "" (index $labels "codex.stage") }}

---
# Values tuned for the lab environment to run the LGTM (Loki, Grafana, Tempo, Mimir) stack
# with modest resource usage and persistent Longhorn storage.
grafana:
  enabled: true
  adminUser: admin
  adminPassword: changeme
  service:
    type: LoadBalancer
    annotations:
      tailscale.com/hostname: lgtm
    loadBalancerClass: tailscale
  persistence:
    enabled: true
    storageClassName: longhorn
    size: 10Gi
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Loki
          uid: loki
          type: loki
          access: proxy
          url: http://lgtm-loki-gateway
          isDefault: false
        - name: Mimir
          uid: prom
          type: prometheus
          access: proxy
          url: http://lgtm-mimir-nginx/prometheus
          isDefault: true
        - name: Tempo
          uid: tempo
          type: tempo
          access: proxy
          url: http://lgtm-tempo-query-frontend:3100
          isDefault: false
          jsonData:
            tracesToLogsV2:
              datasourceUid: loki
            lokiSearch:
              datasourceUid: loki
            tracesToMetrics:
              datasourceUid: prom
            serviceMap:
              datasourceUid: prom

loki:
  enabled: true
  schemaConfig:
    configs:
      - from: "2024-01-01"
        store: boltdb-shipper
        object_store: filesystem
        schema: v13
        index:
          prefix: loki_index_
          period: 24h
  storageConfig:
    boltdb_shipper:
      cache_location: /var/loki/index
      shared_store: filesystem
    filesystem:
      directory: /var/loki/chunks
  readinessProbe:
    failureThreshold: 3
    httpGet:
      path: /ready
      port: http
      scheme: HTTP
    initialDelaySeconds: 30
    periodSeconds: 10
    successThreshold: 1
    timeoutSeconds: 1
  livenessProbe:
    failureThreshold: 3
    httpGet:
      path: /metrics
      port: http
      scheme: HTTP
    initialDelaySeconds: 300
    periodSeconds: 10
    successThreshold: 1
    timeoutSeconds: 1
  structuredConfig:
    ruler:
      storage:
        local:
          directory: /var/loki/rules
  compactor:
    replicas: 1
    persistence:
      enabled: true
      size: 20Gi
      storageClass: longhorn
  ingester:
    replicas: 1
    persistence:
      enabled: true
      claims:
        - name: data
          size: 20Gi
          storageClass: longhorn
    zoneAwareReplication:
      enabled: false
  querier:
    persistence:
      enabled: true
      size: 10Gi
      storageClass: longhorn
  ruler:
    enabled: true
    kind: StatefulSet
    persistence:
      enabled: true
      size: 5Gi
      storageClass: longhorn

mimir:
  enabled: true
  admin_api:
    replicas: 1
  distributor:
    replicas: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
  ingester:
    replicas: 1
    persistentVolume:
      enabled: true
      size: 20Gi
      storageClass: longhorn
  querier:
    replicas: 1
  query_frontend:
    replicas: 1
  query_scheduler:
    replicas: 1
  ruler:
    replicas: 1
  store_gateway:
    replicas: 1
    persistentVolume:
      enabled: true
      size: 20Gi
      storageClass: longhorn
  compactor:
    replicas: 1
    persistentVolume:
      enabled: true
      size: 20Gi
      storageClass: longhorn
  alertmanager:
    replicas: 1
    persistence:
      enabled: true
      storageClass: longhorn
      size: 5Gi
  minio:
    enabled: true
    persistence:
      enabled: true
      size: 50Gi
      storageClass: longhorn

tempo:
  enabled: true
  gateway:
    enabled: true
  traces:
    otlp:
      http:
        enabled: true
      grpc:
        enabled: true
  ingester:
    replicas: 1
    persistence:
      enabled: true
      size: 20Gi
      storageClass: longhorn
  compactor:
    replicas: 1
    persistence:
      enabled: true
      size: 20Gi
      storageClass: longhorn
  querier:
    replicas: 1
  queryFrontend:
    replicas: 1
  distributor:
    replicas: 1
  storage:
    trace:
      backend: local
      block:
        version: vParquet3

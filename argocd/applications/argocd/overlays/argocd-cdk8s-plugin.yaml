apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-repo-server
spec:
  template:
    spec:
      volumes:
        - name: cdk8s-plugin-config
          configMap:
            name: argocd-cdk8s-plugin
        - name: cdk8s-plugin-tmp
          emptyDir: {}
      containers:
        - name: cdk8s-plugin
          image: oven/bun:1.2.23
          command:
            - /bin/sh
          args:
            - -c
            - |
              set -e
              exec /var/run/argocd/argocd-cmp-server --config-dir-path /home/argocd/cmp-server/config
          env:
            - name: NODE_OPTIONS
              value: "--max_old_space_size=512"
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          securityContext:
            runAsNonRoot: true
            runAsUser: 999
          volumeMounts:
            - mountPath: /var/run/argocd
              name: var-files
            - mountPath: /home/argocd/cmp-server/plugins
              name: plugins
            - mountPath: /home/argocd/cmp-server/config/plugin.yaml
              name: cdk8s-plugin-config
              subPath: plugin.yaml
            - mountPath: /tmp
              name: cdk8s-plugin-tmp
        - name: argocd-repo-server
          volumeMounts:
            - mountPath: /home/argocd/cmp-server/config/plugin.yaml
              name: cdk8s-plugin-config
              subPath: plugin.yaml

apiVersion: argoproj.io/v1alpha1
kind: ConfigManagementPlugin
metadata:
  name: cdk8s
spec:
  sourceRepos:
    - https://github.com/proompteng/lab.git
    - https://github.com/proompteng/lab
    - git@github.com:proompteng/lab.git
  allowConcurrency: false
  lockRepo: true
  generate:
    command:
      - /bin/sh
    args:
      - -c
      - |
        set -eu
        HOME_DIR="/tmp/argocd-home"
        mkdir -p "$HOME_DIR"
        export HOME="$HOME_DIR"
        export BUN_INSTALL_CACHE_DIR="$HOME_DIR/.bun-install-cache"
        export HUSKY=0
        APP_PATH="${ARGOCD_APP_SOURCE_PATH:-.}"
        if [ ! -d "$APP_PATH" ]; then
          APP_PATH="."
        fi
        cd "$APP_PATH"
        if [ -f package.json ]; then
          bun install --no-save --cwd . 1>&2
        fi
        WORKDIR="$(mktemp -d)"
        trap 'rm -rf "$WORKDIR"' EXIT
        export CDK8S_OUTDIR="$WORKDIR"
        bun run infra/main.ts 1>&2
        find "$WORKDIR" -maxdepth 1 -type f -name '*.yaml' -print0 |
          sort -z |
          xargs -0 cat

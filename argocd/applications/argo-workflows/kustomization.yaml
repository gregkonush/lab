apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - rbac.yaml
  - ingressroute.yaml
  - argo-workflows-sso-sealedsecret.yaml
helmCharts:
  - name: argo-workflows
    repo: https://argoproj.github.io/argo-helm
    version: 0.45.26
    releaseName: argo-workflows
    namespace: argo-workflows
    valuesInline:
      controller:
        workflowNamespaces:
          - argo-workflows
        extraEnv:
          - name: OTEL_SERVICE_NAME
            value: argo-workflows-controller
          - name: OTEL_SERVICE_NAMESPACE
            value: argo-workflows
          - name: OTEL_EXPORTER_OTLP_PROTOCOL
            value: http/protobuf
          - name: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
            value: http://lgtm-tempo-gateway.lgtm.svc.cluster.local:4318/v1/traces
          - name: OTEL_EXPORTER_OTLP_METRICS_ENDPOINT
            value: http://lgtm-mimir-nginx.lgtm.svc.cluster.local/otlp/v1/metrics
          - name: OTEL_EXPORTER_OTLP_LOGS_ENDPOINT
            value: http://lgtm-loki-gateway.lgtm.svc.cluster.local/loki/api/v1/push
          - name: OTEL_METRICS_EXPORTER
            value: otlp
          - name: OTEL_TRACES_EXPORTER
            value: otlp
          - name: OTEL_LOGS_EXPORTER
            value: otlp
      server:
        secure: false
        authModes:
          - sso
        sso:
          enabled: true
          issuer: https://argocd.proompteng.ai/api/dex
          clientId:
            name: argo-workflows-sso
            key: client-id
          clientSecret:
            name: argo-workflows-sso
            key: client-secret
          redirectUrl: https://workflows.proompteng.ai/oauth2/callback
          scopes:
            - openid
            - profile
            - email
          rbac:
            enabled: true
          insecureSkipVerify: true
        extraEnv:
          - name: OTEL_SERVICE_NAME
            value: argo-workflows-server
          - name: OTEL_SERVICE_NAMESPACE
            value: argo-workflows
          - name: OTEL_EXPORTER_OTLP_PROTOCOL
            value: http/protobuf
          - name: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
            value: http://lgtm-tempo-gateway.lgtm.svc.cluster.local:4318/v1/traces
          - name: OTEL_EXPORTER_OTLP_METRICS_ENDPOINT
            value: http://lgtm-mimir-nginx.lgtm.svc.cluster.local/otlp/v1/metrics
          - name: OTEL_EXPORTER_OTLP_LOGS_ENDPOINT
            value: http://lgtm-loki-gateway.lgtm.svc.cluster.local/loki/api/v1/push
          - name: OTEL_METRICS_EXPORTER
            value: otlp
          - name: OTEL_TRACES_EXPORTER
            value: otlp
          - name: OTEL_LOGS_EXPORTER
            value: otlp
      workflow:
        serviceAccount:
          create: true
          name: argo-workflows-workflow
      artifactRepository:
        archiveLogs: true
  - name: argo-events
    repo: https://argoproj.github.io/argo-helm
    version: 2.4.16
    releaseName: argo-events
    namespace: argo-workflows
    valuesInline:
      singleNamespace: true
      controller:
        metricsConfigMap: ""
      eventsource:
        serviceAccount:
          create: true
      sensor:
        serviceAccount:
          create: false

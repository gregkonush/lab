apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kafka
configMapGenerator:
  - name: kafka-ui-protobufs
    files:
      - discord-commands.proto=../../../proto/facteur/v1/contract.proto
    options:
      disableNameSuffixHash: true
resources:
  # Strimzi operator install (pinned to 0.47.0) â€“ remote raw files
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/010-ServiceAccount-strimzi-cluster-operator.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/020-ClusterRole-strimzi-cluster-operator-role.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/020-RoleBinding-strimzi-cluster-operator.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/021-ClusterRole-strimzi-cluster-operator-role.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/021-ClusterRoleBinding-strimzi-cluster-operator.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/022-ClusterRole-strimzi-cluster-operator-role.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/022-RoleBinding-strimzi-cluster-operator.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/023-ClusterRole-strimzi-cluster-operator-role.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/023-RoleBinding-strimzi-cluster-operator.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/030-ClusterRole-strimzi-kafka-broker.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/030-ClusterRoleBinding-strimzi-cluster-operator-kafka-broker-delegation.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/031-ClusterRole-strimzi-entity-operator.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/031-RoleBinding-strimzi-cluster-operator-entity-operator-delegation.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/033-ClusterRole-strimzi-kafka-client.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/033-ClusterRoleBinding-strimzi-cluster-operator-kafka-client-delegation.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/040-Crd-kafka.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/041-Crd-kafkaconnect.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/042-Crd-strimzipodset.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/043-Crd-kafkatopic.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/044-Crd-kafkauser.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/045-Crd-kafkanodepool.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/046-Crd-kafkabridge.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/047-Crd-kafkaconnector.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/048-Crd-kafkamirrormaker2.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/049-Crd-kafkarebalance.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/050-ConfigMap-strimzi-cluster-operator.yaml
  - https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/0.47.0/install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml
  - strimzi-operator-watched-crb.yaml
  - load-balancer.yaml
  - strimzi-kafka-cluster.yaml
patches:
  # Make the operator watch all namespaces
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: strimzi-cluster-operator
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: strimzi-cluster-operator
      spec:
        template:
          spec:
            containers:
              - name: strimzi-cluster-operator
                env:
                  - name: STRIMZI_NAMESPACE
                    value: "*"
                    valueFrom: null
  # Fix RBAC subjects namespace to match operator namespace
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: ClusterRoleBinding
      name: strimzi-cluster-operator
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: strimzi-cluster-operator
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: ClusterRoleBinding
      name: strimzi-cluster-operator-kafka-client-delegation
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: strimzi-cluster-operator-kafka-client-delegation
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: ClusterRoleBinding
      name: strimzi-cluster-operator-kafka-broker-delegation
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: strimzi-cluster-operator-kafka-broker-delegation
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: RoleBinding
      name: strimzi-cluster-operator
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: strimzi-cluster-operator
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: RoleBinding
      name: strimzi-cluster-operator-leader-election
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: strimzi-cluster-operator-leader-election
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: RoleBinding
      name: strimzi-cluster-operator-entity-operator-delegation
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: strimzi-cluster-operator-entity-operator-delegation
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
helmCharts:
  - name: kafka-ui
    repo: https://kafbat.github.io/helm-charts
    version: 1.5.1
    releaseName: kafka-ui
    namespace: kafka
    # Replace default chart values so list-typed overrides merge correctly.
    valuesMerge: replace
    valuesInline:
      envs:
        secretMappings:
          KAFKA_PASSWORD:
            name: user1
            keyName: password
      volumeMounts:
        - name: kafka-ui-protobufs
          mountPath: /opt/kafbat/protos
          readOnly: true
      volumes:
        - name: kafka-ui-protobufs
          configMap:
            name: kafka-ui-protobufs
      yamlApplicationConfig:
        kafka:
          clusters:
            - name: kafka
              bootstrapServers: kafka-kafka-bootstrap:9092
              properties:
                security.protocol: SASL_PLAINTEXT
                sasl.mechanism: SCRAM-SHA-512
                sasl.jaas.config: 'org.apache.kafka.common.security.scram.ScramLoginModule required username="user1" password="${KAFKA_PASSWORD}";'
              serde:
                - name: Utf8String
                  className: io.kafbat.ui.serdes.builtin.StringSerde
                  properties:
                    encoding: UTF-8
                - name: DiscordCommandsProto
                  className: io.kafbat.ui.serdes.builtin.ProtobufFileSerde
                  topicValuesPattern: '^discord\.commands\.incoming(\.dlq)?$'
                  properties:
                    protobufFilesDir: /opt/kafbat/protos
                    protobufMessageName: facteur.v1.CommandEvent
                    protobufMessageNameByTopic:
                      discord.commands.incoming: facteur.v1.CommandEvent
                      discord.commands.incoming.dlq: facteur.v1.CommandEvent
        auth:
          type: disabled
        management:
          health:
            ldap:
              enabled: false

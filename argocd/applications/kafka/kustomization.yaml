apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kafka
resources:
  - https://github.com/strimzi/strimzi-kafka-operator/releases/download/0.47.0/strimzi-crds-0.47.0.yaml
  - https://github.com/strimzi/strimzi-kafka-operator/releases/download/0.47.0/strimzi-cluster-operator-0.47.0.yaml
  - load-balancer.yaml
  - strimzi-kafka-cluster.yaml
patches:
  # Make the operator watch all namespaces
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: strimzi-cluster-operator
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: strimzi-cluster-operator
      spec:
        template:
          spec:
            containers:
              - name: strimzi-cluster-operator
                env:
                  - name: STRIMZI_NAMESPACE
                    value: "*"
  # Fix RBAC subjects namespace to match operator namespace
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: ClusterRoleBinding
      name: strimzi-cluster-operator
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: strimzi-cluster-operator
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: ClusterRoleBinding
      name: strimzi-cluster-operator-kafka-client-delegation
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: strimzi-cluster-operator-kafka-client-delegation
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: ClusterRoleBinding
      name: strimzi-cluster-operator-kafka-broker-delegation
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: strimzi-cluster-operator-kafka-broker-delegation
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: RoleBinding
      name: strimzi-cluster-operator
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: strimzi-cluster-operator
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: RoleBinding
      name: strimzi-cluster-operator-leader-election
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: strimzi-cluster-operator-leader-election
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: RoleBinding
      name: strimzi-cluster-operator-entity-operator-delegation
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: strimzi-cluster-operator-entity-operator-delegation
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
  - target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: RoleBinding
      name: strimzi-cluster-operator-watched
    patch: |-
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: strimzi-cluster-operator-watched
      subjects:
        - kind: ServiceAccount
          name: strimzi-cluster-operator
          namespace: kafka
helmCharts:
  - name: kafka-ui
    repo: https://kafbat.github.io/helm-charts
    version: 1.5.1
    releaseName: kafka-ui
    namespace: kafka
    valuesInline:
      envs:
        env:
          - name: KAFKA_CLUSTERS_0_NAME
            value: kafka
          - name: KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS
            value: kafka-kafka-bootstrap:9092
          - name: KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL
            value: SASL_PLAINTEXT
          - name: KAFKA_CLUSTERS_0_PROPERTIES_SASL_MECHANISM
            value: SCRAM-SHA-512
          - name: KAFKA_CLUSTERS_0_PROPERTIES_SASL_JAAS_CONFIG
            value: 'org.apache.kafka.common.security.scram.ScramLoginModule required username="user1" password="$(KAFKA_PASSWORD)";'
        secretMappings:
          KAFKA_PASSWORD:
            name: user1
            keyName: password
      yamlApplicationConfig:
        auth:
          type: disabled
        management:
          health:
            ldap:
              enabled: false

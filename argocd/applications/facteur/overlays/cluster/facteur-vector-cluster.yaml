---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: facteur-vector-cluster
  namespace: facteur
spec:
  imageName: registry.ide-newton.ts.net/lab/vecteur:pg18-trixie
  imagePullPolicy: Always
  instances: 3
  resources:
    requests:
      cpu: "1"
      memory: "512Mi"
    limits:
      cpu: "2"
      memory: "1Gi"
  storage:
    storageClass: longhorn
    size: 20Gi
  bootstrap:
    initdb:
      database: facteur_kb
      owner: facteur
      dataChecksums: true
      encoding: "UTF8"
      postInitSQL:
        - CREATE EXTENSION IF NOT EXISTS vector;
        - CREATE EXTENSION IF NOT EXISTS pgcrypto;
      postInitApplicationSQL:
        - |
          CREATE SCHEMA IF NOT EXISTS codex_kb AUTHORIZATION facteur;
        - |
          CREATE TABLE IF NOT EXISTS codex_kb.runs (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            repo_slug TEXT NOT NULL,
            issue_number INTEGER NOT NULL,
            workflow TEXT NOT NULL,
            run_started_at TIMESTAMPTZ NOT NULL DEFAULT now(),
            run_completed_at TIMESTAMPTZ,
            metadata JSONB NOT NULL DEFAULT '{}'::jsonb,
            created_at TIMESTAMPTZ NOT NULL DEFAULT now()
          );
        - |
          ALTER TABLE codex_kb.runs OWNER TO facteur;
        - |
          CREATE TABLE IF NOT EXISTS codex_kb.entries (
            id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            run_id UUID NOT NULL REFERENCES codex_kb.runs(id) ON DELETE CASCADE,
            step_label TEXT NOT NULL,
            artifact_type TEXT NOT NULL,
            artifact_stage TEXT NOT NULL,
            embedding vector(1536),
            content TEXT NOT NULL,
            metadata JSONB NOT NULL DEFAULT '{}'::jsonb,
            created_at TIMESTAMPTZ NOT NULL DEFAULT now()
          );
        - |
          ALTER TABLE codex_kb.entries OWNER TO facteur;
        - |
          CREATE INDEX IF NOT EXISTS codex_kb_entries_embedding_idx
          ON codex_kb.entries
          USING ivfflat (embedding vector_cosine_ops)
          WITH (lists = 100);
        - |
          GRANT USAGE ON SCHEMA codex_kb TO facteur;
        - |
          GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA codex_kb
          TO facteur;
        - |
          ALTER DEFAULT PRIVILEGES IN SCHEMA codex_kb
          GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO facteur;
